<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä To-Do Pro Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-light: #faf8f5;
      --bg-dark: #1f1f1f;
      --card-dark: #2b2b2b;
      --accent: #e0c097;
      --text-dark: #444;
      --text-light: #f5f5f5;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-light);
      color: var(--text-dark);
      transition: background 0.4s, color 0.4s;
    }
    body.dark { background-color: var(--bg-dark); color: var(--text-light); }

    header {
      text-align: center;
      padding: 20px 10px 10px;
      font-size: 1.6em;
      font-weight: 600;
    }

    .dashboard-container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto 80px;
    }

    /* ===== ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ ===== */
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 18px;
      text-align: center;
      border: 1.5px solid var(--accent);
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      transition: 0.3s;
    }
    .card:hover { transform: translateY(-4px); }
    body.dark .card { background: var(--card-dark); }

    .card h3 {
      margin: 5px 0;
      font-size: 1.1em;
      font-weight: 500;
    }
    .card span {
      font-size: 1.4em;
      font-weight: 600;
      color: var(--accent);
    }

    /* ===== ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° ===== */
    .circle-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      margin: 30px 0;
    }
    .progress-circle {
      position: relative;
      width: 150px;
      height: 150px;
    }
    .progress-circle svg {
      transform: rotate(-90deg);
      width: 150px;
      height: 150px;
    }
    circle {
      fill: none;
      stroke-width: 12;
      stroke-linecap: round;
    }
    .bg-ring { stroke: #e5dfd6; }
    .progress-ring { stroke: var(--accent); stroke-dasharray: 440; stroke-dashoffset: 440; transition: stroke-dashoffset 0.6s ease; }
    .percent-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 22px;
      font-weight: 600;
      color: var(--text-dark);
    }
    body.dark .percent-text { color: var(--text-light); }

    /* ===== ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° ===== */
    .weekly-chart {
      margin-top: 40px;
      text-align: center;
    }
    .weekly-chart h3 {
      font-weight: 500;
      margin-bottom: 10px;
    }
    .chart-line {
      width: 100%;
      height: 160px;
      background: linear-gradient(to bottom, #fefaf4, #faf8f5);
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      padding: 10px;
    }
    .bar {
      width: 10%;
      background-color: var(--accent);
      border-radius: 4px 4px 0 0;
      transition: height 0.5s ease;
    }
    .bar-label {
      font-size: 12px;
      margin-top: 5px;
      color: #666;
    }
    body.dark .bar-label { color: #ccc; }

    /* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö ===== */
    .back-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 55px;
      height: 55px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: 0.3s;
    }
    .back-btn:hover { transform: scale(1.1); }

    /* Responsive */
    @media (max-width: 768px) {
      .card h3 { font-size: 1em; }
      .card span { font-size: 1.3em; }
    }
  </style>
</head>

<body>
  <header>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Dashboard)</header>
  <div class="dashboard-container">
    <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ -->
    <div class="summary">
      <div class="card"><h3>‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><span id="totalTasks">0</span></div>
      <div class="card"><h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</h3><span id="doneTasks">0</span></div>
      <div class="card"><h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3><span id="pendingTasks">0</span></div>
      <div class="card"><h3>‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô</h3><span id="workTasks">0</span></div>
      <div class="card"><h3>‡∏´‡∏°‡∏ß‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3><span id="personalTasks">0</span></div>
    </div>

    <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° -->
    <div class="circle-container">
      <h3>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
      <div class="progress-circle">
        <svg>
          <circle class="bg-ring" cx="75" cy="75" r="70"></circle>
          <circle class="progress-ring" cx="75" cy="75" r="70"></circle>
        </svg>
        <div class="percent-text" id="percentText">0%</div>
      </div>
    </div>

    <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° -->
    <div class="weekly-chart">
      <h3>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô‡∏£‡∏≠‡∏ö 7 ‡∏ß‡∏±‡∏ô</h3>
      <div class="chart-line" id="chartLine"></div>
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö -->
  <button class="back-btn" onclick="location.href='index.html'">üè†</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, getDocs } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_7tyj_BAyFzKEYVrZXfQjWCUXGS7VqKY",
      authDomain: "my-todo-list-9d2fa.firebaseapp.com",
      projectId: "my-todo-list-9d2fa",
      storageBucket: "my-todo-list-9d2fa.appspot.com",
      messagingSenderId: "631403892452",
      appId: "1:631403892452:web:66d382bf5f143fc05de6f1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
    if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark");

    async function loadDashboard() {
      const snapshot = await getDocs(collection(db, "tasks"));
      const tasks = snapshot.docs.map(d => d.data());

      const total = tasks.length;
      const done = tasks.filter(t => t.completed).length;
      const pending = total - done;
      const work = tasks.filter(t => t.category === "work").length;
      const personal = tasks.filter(t => t.category === "personal").length;

      document.getElementById("totalTasks").textContent = total;
      document.getElementById("doneTasks").textContent = done;
      document.getElementById("pendingTasks").textContent = pending;
      document.getElementById("workTasks").textContent = work;
      document.getElementById("personalTasks").textContent = personal;

      // üîò ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°
      const percent = total ? Math.round((done / total) * 100) : 0;
      const circle = document.querySelector(".progress-ring");
      const offset = 440 - (440 * percent) / 100;
      circle.style.strokeDashoffset = offset;
      document.getElementById("percentText").textContent = percent + "%";

      // üìà ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏¥‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°
      updateWeeklyChart(tasks);
    }

    function updateWeeklyChart(tasks) {
      const chart = document.getElementById("chartLine");
      chart.innerHTML = "";
      const today = new Date();
      const days = [...Array(7)].map((_, i) => {
        const d = new Date(today);
        d.setDate(today.getDate() - (6 - i));
        return d.toISOString().slice(0, 10);
      });

      const data = days.map(day => 
        tasks.filter(t => {
          if (!t.completed) return false;
          const dateStr = t.createdAt ? new Date(t.createdAt).toISOString().slice(0,10) : "";
          return dateStr === day;
        }).length
      );

      const maxVal = Math.max(...data, 1);
      days.forEach((day, i) => {
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.height = `${(data[i] / maxVal) * 100}%`;

        const container = document.createElement("div");
        container.style.display = "flex";
        container.style.flexDirection = "column";
        container.style.alignItems = "center";

        const label = document.createElement("div");
        label.className = "bar-label";
        const date = new Date(day);
        label.textContent = date.toLocaleDateString("th-TH", { weekday: "short" });

        container.appendChild(bar);
        container.appendChild(label);
        chart.appendChild(container);
      });
    }

    loadDashboard();
  </script>
</body>
</html>
